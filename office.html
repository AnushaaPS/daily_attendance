<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Office Dashboard – Attendance Reports</title>
  <script src="common.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f7ff;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #1e3a8a;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 30px auto;
      text-align: center;
    }
    button, input, select {
      padding: 8px 14px;
      margin: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    .btn {
      background: linear-gradient(135deg,#2563eb,#1e40af);
      color: white;
      border: none;
      cursor: pointer;
      transition: .2s;
    }
    .btn:hover { transform: scale(1.05); }
    footer {
      text-align: center;
      color: #555;
      margin-top: 40px;
      font-size: 14px;
    }
  </style>
</head>

<body onload="initOffice()">

  <h2>Office Dashboard – Attendance Reports</h2>
  <button class="btn" onclick="logout()">Logout</button>
  <div class="section">
    <h3>Download Attendance Reports</h3>
    <label>Date:
      <input type="date" id="date">
    </label>
    <label>Batch:
      <select id="batch">
        <option value="FN">FN</option>
        <option value="AN">AN</option>
      </select>
    </label>
    <br>
    <button class="btn" onclick="downloadAbsentees()">Download Absentees CSV</button>
    <button class="btn" onclick="downloadOD()">Download OD CSV</button>
    <button class="btn" onclick="loadAttendanceStatus()">View Status</button>
  </div>

  <footer>College Attendance System</footer>

  <script>
    let absenteesData = [];
    let odData = [];

    function initOffice() {
      const user = requireRole("Office");
      if (!user) return;
    }

    /* === Fetch Data === */
    async function fetchAttendanceData() {
  const date = document.getElementById("date").value;
  const batch = document.getElementById("batch").value;
  if (!date) { alert("Please select a date."); return null; }

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getCollegeAbsenteesForOffice", date, batch })
  });
  const data = await res.json();

  if (!data.success) {
    alert(data.message || "Failed to fetch data.");
    return null;
  }

  // ✅ Fixed property names
  absenteesData = data.absentees || [];
  odData = data.ods || [];

  return true;
}

    /* === Download Absentees CSV === */
    async function downloadAbsentees() {
      const ok = await fetchAttendanceData();
      if (!ok || !absenteesData.length) {
        alert("No absentees found for this date and batch.");
        return;
      }

      const headers = [
        "RollNo","Name","Department","Year","Section","Reason","ParentName","ParentPhone"
      ];
      let csv = headers.join(",") + "\n";
      absenteesData.forEach(r => {
        csv += [
          r.RollNo || "", r.Name || "", r.Department || "", r.Year || "",
          r.Section || "", r.Reason || "", r.ParentName || "", r.ParentPhone || ""
        ].join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `Absentees_${document.getElementById("date").value}_${document.getElementById("batch").value}.csv`;
      a.click();
    }

    /* === Download OD CSV === */
    async function downloadOD() {
      const ok = await fetchAttendanceData();
      if (!ok || !odData.length) {
        alert("No OD records found for this date and batch.");
        return;
      }

      const headers = [
        "RollNo","Name","Department","Year","Section","Reason","ParentName","ParentPhone"
      ];
      let csv = headers.join(",") + "\n";
      odData.forEach(r => {
        csv += [
          r.RollNo || "", r.Name || "", r.Department || "", r.Year || "",
          r.Section || "", r.Reason || "", r.ParentName || "", r.ParentPhone || ""
        ].join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `OD_${document.getElementById("date").value}_${document.getElementById("batch").value}.csv`;
      a.click();
    }

async function loadAttendanceStatus() {
  const date = document.getElementById("date").value;
  console.log(date)
  const batch = document.getElementById("batch").value;
  if (!date) return alert("Select a date");

  const res = await fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({ action: "getAttendanceStatusSummary", date, batch })
  });
  const data = await res.json();
  if (!data.success) return alert(data.message);

  let html = `<div id="popupOverlay" style="
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.5);
        display: flex; align-items: center; justify-content: center;
        z-index: 9999;">
      <div id="popupBox" style="
        background: white; border-radius: 10px; padding: 25px; 
        width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
        <h3 style="color:#1e3a8a; text-align:center;">Attendance Status for ${date} (${batch})</h3>
        <button style="float:right; margin-top:-35px; background:red; color:white; border:none; border-radius:6px; padding:6px 10px; cursor:pointer;"
                onclick="document.getElementById('popupOverlay').remove()">Close</button>
        <div style="margin-top:20px;">`;

  if (!data.summary.length) {
    html += `<p>No records found for selected date & batch.</p>`;
  } else {
    data.summary.forEach(deptData => {
      html += `<h4 style="margin-top:20px;color:#1e3a8a;">${deptData.department}</h4>`;
      html += `<div style="display:flex; flex-wrap:wrap; gap:10px;">`;

      deptData.records
        .sort((a,b)=> (a.Year+b.Section).localeCompare(b.Year+b.Section))
        .forEach(r => {
          let color = "gray";
          let statusText = r.Status;
          if (r.Status === "Taken") color = "green";
          else if (r.Status === "Not Taken") color = "red";
          html += `<div style="
              background:#f9f9ff;
              border-left:6px solid ${color};
              padding:10px 15px;
              border-radius:8px;
              min-width:120px;
              text-align:center;
              font-weight:600;
            ">
              ${r.Year}-${r.Section}<br>
              <span style="color:${color};">${statusText}</span>
            </div>`;
        });

      html += `</div>`;
    });
  }

  html += `</div></div></div>`;
  document.body.insertAdjacentHTML("beforeend", html);
}
  </script>

</body>
</html>
